---
sun:
  latitude: !secret latitude
  longitude: !secret longitude
  on_sunset:
    - elevation: -3.5Â°
      then:
        - select.set:
            id: brightness_mode
            option: "Evening"
  on_sunrise:
    - then:
        - select.set:
            id: brightness_mode
            option: "Day"

time:
  - platform: sntp
    timezone: $timezone
    id: system_time
    update_interval: 360min   # Change sync interval from default 5min to 6 hours
    on_time:
      - seconds: 0
        minutes: $screen_night_minute
        hours: $screen_night_hour
        then:
          - select.set:
              id: brightness_mode
              option: "Night"
      # Burn-in prevention: exercise pixels 4 times per night for 30 minutes each
      - hours: 2,3,4,5
        minutes: 5
        seconds: 0
        then:
          - switch.turn_on: switch_antiburn
      - hours: 2,3,4,5
        minutes: 35
        seconds: 0
        then:
          - switch.turn_off: switch_antiburn

lvgl:
  on_idle:
    timeout: $touchscreen_idle_timeout
    then:
      - logger.log: "LVGL is idle"
      - if:
          condition:
            - lambda: 'return id(brightness_mode).current_option() == "Day";'
          then:
            - light.turn_on:
                id: display_backlight
                brightness: ${touchscreen_daytime_brightness}
      - if:
          condition:
            - lambda: 'return id(brightness_mode).current_option() == "Evening";'
          then:
            - light.turn_on:
                id: display_backlight
                brightness: ${touchscreen_nighttime_brightness}
      - if:
          condition:
            - lambda: 'return id(brightness_mode).current_option() == "Night";'
          then:
            - light.turn_off: display_backlight
            - lvgl.pause:
                show_snow: true

# Wake on screen touch
touchscreen:
    on_touch:
      then:
        - logger.log: "LVGL is active"
        # Stop antiburn if active
        - if:
            condition: lvgl.is_paused
            then:
              - switch.turn_off: switch_antiburn
        - lvgl.resume
        - lvgl.widget.redraw
        - if:
            condition:
              - lambda: 'return id(brightness_mode).current_option() == "Day";'
            then:
              - light.turn_on:
                  id: display_backlight
                  brightness: 100%  # 80% + 30% = 110%, capped at 100%
        - if:
            condition:
              - lambda: 'return id(brightness_mode).current_option() == "Evening";'
            then:
              - light.turn_on:
                  id: display_backlight
                  brightness: 80%  # 50% + 30% = 80%
        - if:
            condition:
              - lambda: 'return id(brightness_mode).current_option() == "Night";'
            then:
              - light.turn_on:
                  id: display_backlight
                  brightness: 30%  # Night mode off + 30% boost = 30%

# Anti-burn switch for LCD burn-in prevention
switch:
  - platform: template
    name: "Antiburn"
    id: switch_antiburn
    icon: mdi:television-shimmer
    optimistic: true
    entity_category: "config"
    turn_on_action:
      - logger.log: "Starting Antiburn"
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:
      - lvgl.pause:
          show_snow: true
      # Turn off backlight during antiburn to save power and avoid disturbing users
      - light.turn_off: display_backlight
    turn_off_action:
      - logger.log: "Stopping Antiburn"
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:

# Brightness mode field
select:
  - platform: template
    name: "Brightness mode"
    id: brightness_mode
    icon: mdi:television-shimmer
    optimistic: true
    options:
      - Day
      - Evening
      - Night
    initial_option: Day
    on_value:
      then:
        - lvgl.resume
        - lvgl.widget.redraw
        - if:
            condition:
              - lambda: 'return id(brightness_mode).current_option() == "Day";'
            then:
              - light.turn_on:
                  id: display_backlight
                  brightness: ${touchscreen_daytime_brightness}
        - if:
            condition:
              - lambda: 'return id(brightness_mode).current_option() == "Evening";'
            then:
              - light.turn_on:
                  id: display_backlight
                  brightness: ${touchscreen_nighttime_brightness}
        - if:
            condition:
              - lambda: 'return id(brightness_mode).current_option() == "Night";'
            then:
              - light.turn_off: display_backlight
              - lvgl.pause:
                  show_snow: true
